%! TEX root = thesis.tex
% vim: ft=tex fdm=manual nospell et sts=2 sw=2

% Common packages and preamble.

\makeatletter

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

% Whitespace and margins -----------------------------------------------

\ifsustyle
  \setlrmarginsandblock{1in}{1in}{*} % left-right margins
  \setulmarginsandblock{1in}{1in}{*} % up-lower margins
  \DoubleSpacing
  % \OnehalfSpacing
\else
  % height = 10in, width = 7in.
  \setstocksize{10in}{7in}
  \settrimmedsize{\stockheight}{\stockwidth}{*}
  \setulmarginsandblock{1in}{1in}{*} % up-lower margins

  % left + right = 1.65in to get a total textwidth of
  % 7in - 1.65in = 386pt.
  \ifdeadtree
    \setlrmarginsandblock{0.75in}{0.9in}{*}
  \else
    \setlrmarginsandblock{0.825in}{0.825in}{*}
  \fi
\fi

% Important.  Potato layout otherwise.
\checkandfixthelayout

% Packages (draft vs. final) -------------------------------------------

\ifdraftdoc
  \usepackage[draft]{emem}
\else
  \usepackage{emem}
  \usepackage{pdfpages}
  \usepackage{xcolor}

  % No colors for links in printed version.
  \ifdeadtree
    \colorlet{general}{black}
    \colorlet{backref}{black}
  \else
    \colorlet{general}{bs1}
    \colorlet{backref}{nord11}
  \fi

  \hypersetup{
    pdfauthor={Manu Mannattil},
    pdftitle={Asymptotics, Geometry, and Soft Matter},
    pdfsubject={soft condensed matter, statistical mechanics, asymptotics, geometry},
    pdfkeywords={free energy, frameworks, waves, WKB},
    linktocpage=true,
    allcolors=general
  }

  % Line numbers only in non-draft versions.
  % NOTE: this screws up hyperlinks to footnotes.
  \iflinenumbers
    \usepackage{lineno}
    \usepackage{fnlineno}
    \def\linenumbersep{10pt}
    \linenumbers
    \def\linenumberfont{\color{gray}\normalfont\footnotesize\ttfamily}
  \fi
\fi

% Other packages -------------------------------------------------------

\usepackage{acronym}
\usepackage{fourierx} % fonts

% Set up path for graphicsx.
\graphicspath{{figures/}}

% More Syracuse BS -----------------------------------------------------

\ifsustyle
  % The fonts in the figures are at 10pt.  SU "demands" a font size of 12
  % pt.  Thus, scale all figures by 1.2.
  % Note that global scaling doesn't work for \includegraphics.
  % https://tex.stackexchange.com/a/83074
  \let\includefigure\includegraphics
  \renewcommand{\includegraphics}[2][]{\includefigure[scale=1.2,#1]{#2}}
\fi

% Natbib or BibLaTeX? --------------------------------------------------

\ifdraftdoc
  % Use natbib in draft mode since it's much faster than BibLaTeX.
  \usepackage[square,merge,numbers,sort&compress]{natbib}
\else
  % We're all living in Amerika
  % Amerika ist wunderbar
  % ---
  % No, seriously, we need this if we want punctuation inside quotation
  % marks, i.e., "as the period that ends this sentence."
  \usepackage[american]{babel}
  \usepackage{csquotes}

  % Use BibLaTeX in non-draft mode since it supports back references.
  \usepackage[
    backend=biber,
    style=phys,        % use biblatex-phys, i.e., APS/Phys. Rev. style
    eprint=true,       % phys: include arXiv info
    chaptertitle=true, % phys: include chapter titles for @incollection
    biblabel=brackets, % phys: square brackets, e.g., [12], and not superscripts
    pageranges=false,  % phys: just page number
    backref,           % back references in bibliography
    natbib,            % allows usage of \citet{...} and other natbib commands
    sorting=nyt        % sort according to name/year/title
  ]{biblatex}

  % Formatting of back references.
  \DefineBibliographyStrings{american}{
    backrefpage = {cited on p.~},
    backrefpages = {cited on pp.~},
  }

  % Problem: for @book, @techreport, etc., biblatex-phys doesn't convert
  % titles to clickable hyperlinks if there is a URL.
  % Adapted from: https://tex.stackexchange.com/a/48409
  %               https://tex.stackexchange.com/a/471442
  \newbibmacro{string+doiurl}[1]{%
    \iffieldundef{doi}{%
      \iffieldundef{url}{%
        #1%
      }{%
        \href{\thefield{url}}{#1}%
      }%
    }{%
      \href{https://doi.org/\thefield{doi}}{#1}%
    }%
  }
  \DeclareFieldFormat{title}{\usebibmacro{string+doiurl}{\mkbibemph{#1}}}
  \DeclareFieldFormat[phdthesis,thesis]{title}%
    {\usebibmacro{string+doiurl}{\mkbibquote{#1}}}

  % Titlecase book titles.
  \DeclareFieldFormat{titlecase}{#1}

  % Author names should be formatted as
  %   First, A., B. Second, C. Third, ...
  \DeclareNameAlias{author}{family-given/given-family}
  \DeclareNameAlias{default}{family-given}

  \addbibresource{library.bib}
\fi

% Commands -------------------------------------------------------------

% Command to typeset with more separation between characters and words.
% For reasons I don't understand, using \MakeUppercase doesn't work inside
% widetext, so you have to manually type in all caps (if you want that).
% Requires microtype for \textls: https://tex.stackexchange.com/q/23921
% Note also that this is not the same command as REVTeX's \widetext.
\ifsustyle
  \def\widetext#1{#1}
\else
  \def\widetext#1{\textls[120]{%
    \spaceskip=1.5\fontdimen2\font plus 1.5\fontdimen3\font minus 1.5\fontdimen4\font%
    {#1}%
  }}
\fi

% Link DOIs and arXiv preprints.
\def\crossref#1#2{\href{https://doi.org/#1}{#2}}
\def\arxiv#1#2{\href{https://arxiv.org/abs/#1}{arXiv:#1 [#2]}}

% Command to make a blank page if we're using a two-side layout.
\def\twosideblankpage{\if@twoside\blankpage\fi}

% Math -----------------------------------------------------------------

% Chapter-wise equation numbers.
\numberwithin{equation}{chapter}

\def\free#1{\ensuremath\mathcal{A}_{\hat{#1}}(#1)}
\def\mpd#1{\ensuremath\mathcal{P}_{\hat{#1}}(#1)}
\def\inmat#1{\ensuremath\begin{pmatrix}#1\end{pmatrix}}

% Math definitions.
\def\ogets#1{\ensuremath\overset{\gets}{#1}}
\def\oto#1{\ensuremath\overset{\to}{#1}}

% Memoir tweaks --------------------------------------------------------

% Chapter precis (i.e., abstract for a chapter) tweaks.
% TODO: How to control spacing after the precis without a \\?
\setlength{\prechapterprecisshift}{-\baselineskip}
\def\precisfont{\normalfont\small}

% Wider character spacing in headers.
\def\headerstyle#1{\textls[90]{#1}}
\makeevenhead{headings}{\headerstyle{\thepage}}{\headerstyle{\leftmark}}{}
\makeoddhead{headings}{}{\headerstyle{\rightmark}}{\headerstyle{\thepage}}

%%% End notes ----------------------------------------------------------

% % memoir allows customization of the endnotes heading, but it doesn't
% % seem to add the heading to the TOC.  But I want to add customized
% % headings to the TOC, so we use a blank heading and define a \section*
% % the usual way.
% % Patch \printpagenotes to use a \section*.
% \let\oldprintpagenotes\printpagenotes
% \def\printpagenotes{%
%   \section*{Notes for Chapter \thechapter}
%   \addcontentsline{toc}{section}{Notes for Chapter \thechapter}
%   \oldprintpagenotes
% }
%
% \makepagenote                                           % enable endnotes
% \renewcommand*{\notesname}{Chapter Notes}               % endnotes heading
% \renewcommand*{\notedivision}{}                         % suppress endnote title
% \renewcommand*{\pagenotesubhead}[3]{}
%
% % Backlinks.  This messes up hanging indentation.
% % \notepageref
%
% % Hanging indent for endnotes.
% % https://tex.stackexchange.com/a/57515
% \renewcommand*\prenotetext{%
%   \list{}{%
%     \setlength\leftmargin{2em}%
%     \setlength\topsep{-\baselineskip}}
%   \item}
% \renewcommand*\postnotetext{\endlist\bigskip\medskip}
% \renewcommand*\idtextinnotes[1]{#1.\vspace*{-\baselineskip}}
% \renewcommand*\notenuminnotes[1]{#1.\vspace*{-\baselineskip}}

\makeatother
