%! TEX root = thesis.tex
% vim: ft=tex fdm=manual nospell et sts=2 sw=2

% Common packages and preamble.

\makeatletter

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

% Whitespace and margins -----------------------------------------------

\ifsustyle
  \setlrmarginsandblock{1in}{1in}{*} % left-right margins
  \setulmarginsandblock{1in}{1in}{*} % up-lower margins
  \DoubleSpacing
  % \OnehalfSpacing
\else
  % In both the below cases, we need the block size
  % to be 8in x 5.35in.
  \ifdeadtree
    % letter-size paper
    \setstocksize{11in}{8.5in}
    \settrimmedsize{\stockheight}{\stockwidth}{*}
    \setulmarginsandblock{1.575in}{1.575in}{*}
    \setlrmarginsandblock{1.5in}{1.5in}{*}
  \else
    % height = 10in, width = 7in
    \setstocksize{10in}{7in}
    \settrimmedsize{\stockheight}{\stockwidth}{*}
    \setulmarginsandblock{1in}{1in}{*} % up-lower margins
    \setlrmarginsandblock{0.825in}{0.825in}{*} % left-right margins
  \fi
\fi

% \ifdraftdoc
%   \DoubleSpacing
% \fi

% Important.  Potato layout otherwise.
\checkandfixthelayout

% Squeeze whitespace in (numbered) lists.
\usepackage{enumitem}
\setlist[itemize]{noitemsep, topsep=2pt, label=(\roman*)}
\setlist[enumerate]{noitemsep, topsep=2pt, label=(\roman*)}

% Sensible whitespace.
\setlength{\abovecaptionskip}{1pt plus 2pt}
\setlength{\belowcaptionskip}{1pt plus 2pt}
\setlength{\textfloatsep}{16pt plus 4pt minus 4pt}
\setlength{\skip\footins}{16pt plus 4pt minus 4pt}
\setlength{\parskip}{0pt}

% Reduce space before/after equations.
% https:/tex.stackexchange.com/a/47776
\g@addto@macro \normalsize {%
  \setlength{\abovedisplayskip}{6pt plus 1pt minus 2pt}%
  \setlength{\abovedisplayshortskip}{0pt minus 2pt}%
  \setlength{\belowdisplayskip}{6pt plus 1pt minus 2pt}%
  \setlength{\belowdisplayshortskip}{4pt plus 1pt minus 1pt}%
}

% Hack to almost completely remove orphans.
% NOTE: this produces unbalanced pages.
% See Section 3.5 of the memoir docs.
% \setlength{\topskip}{1.5\topskip}
% \checkandfixthelayout
% \sloppybottom

% Caption of figures = 85% of textwidth.
\changecaptionwidth
\captionwidth{0.85\textwidth}

% Important.  Potato layout otherwise.
\checkandfixthelayout

% Packages (draft vs. final) -------------------------------------------

\ifdraftdoc
  \usepackage[draft]{emem}
\else
  \usepackage{emem}
  \usepackage{xcolor}

  % No colors for links in printed version.
  \ifdeadtree
    \colorlet{general}{black}
    \colorlet{backref}{black}
  \else
    \colorlet{general}{bs1}
    \colorlet{backref}{nord11}
  \fi

  \hypersetup{
    pdfauthor={Manu Mannattil},
    pdftitle={Asymptotics, Geometry, and Soft Matter},
    pdfsubject={soft condensed matter, statistical mechanics, asymptotics, geometry},
    pdfkeywords={free energy, frameworks, waves, WKB},
    linktocpage=true,
    allcolors=general
  }

  % Line numbers only in non-draft versions.
  % NOTE: this screws up hyperlinks to footnotes.
  \iflinenumbers
    \usepackage{lineno}
    \usepackage{fnlineno}
    \def\linenumbersep{10pt}
    \linenumbers
    \def\linenumberfont{\color{gray}\normalfont\footnotesize\ttfamily}
  \fi
\fi

% Other packages -------------------------------------------------------

\usepackage{acronym}
\usepackage{fourierx} % fonts
%\usepackage{lmodern,amssymb,mathrsfs,stmaryrd,bm} % fonts

% Set up path for graphicsx.
\graphicspath{{figures}}

% More Syracuse BS -----------------------------------------------------

\ifsustyle
  % The fonts in the figures are at 10pt.  SU "demands" a font size of 12
  % pt.  Thus, scale all figures by 1.2.
  % Note that global scaling doesn't work for \includegraphics.
  % https:/tex.stackexchange.com/a/83074
  \let\includefigure\includegraphics
  \renewcommand{\includegraphics}[2][]{\includefigure[scale=1.2,#1]{#2}}
\fi

% Natbib or BibLaTeX? --------------------------------------------------

\ifdraftdoc
  % Use natbib in draft mode since it's much faster than BibLaTeX.
  \usepackage[square,merge,numbers,sort&compress]{natbib}
\else
  % We're all living in Amerika
  % Amerika ist wunderbar
  % ---
  % No, seriously, we need this if we want punctuation inside quotation
  % marks, i.e., "as the period that ends this sentence."
  \usepackage[american]{babel}
  \usepackage{csquotes}

  % Use BibLaTeX in non-draft mode since it supports back references.
  \usepackage[
    backend=biber,
    style=phys,        % use biblatex-phys, i.e., APS/Phys. Rev. style
    eprint=true,       % phys: include arXiv info
    chaptertitle=true, % phys: include chapter titles for @incollection
    biblabel=brackets, % phys: square brackets, e.g., [12], and not superscripts
    pageranges=false,  % phys: just the first page number, and not the range: 1-10 vs 1
    backref,           % back references in bibliography
    natbib,            % allows usage of \citet{...} and other natbib commands
    sorting=nyt        % sort according to name/year/title
  ]{biblatex}

  % Formatting of back references.
  \DefineBibliographyStrings{american}{
    backrefpage = {cited on p.~},
    backrefpages = {cited on pp.~},
  }

  % Problem: for @book, @techreport, etc., biblatex-phys doesn't convert
  % titles to clickable hyperlinks if there is a URL.
  % Adapted from: https:/tex.stackexchange.com/a/48409
  %               https:/tex.stackexchange.com/a/471442
  \newbibmacro{string+doiurl}[1]{%
    \iffieldundef{doi}{%
      \iffieldundef{url}{%
        #1%
      }{%
        \href{\thefield{url}}{#1}%
      }%
    }{%
      \href{https:/doi.org/\thefield{doi}}{#1}%
    }%
  }
  \DeclareFieldFormat{title}{\usebibmacro{string+doiurl}{\mkbibemph{#1}}}
  \DeclareFieldFormat[phdthesis,thesis]{title}%
    {\usebibmacro{string+doiurl}{\mkbibquote{#1}}}

  % Titlecase book titles.
  \DeclareFieldFormat{titlecase}{#1}

  % Author names should be formatted as
  %   First, A., B. Second, C. Third, ...
  \DeclareNameAlias{author}{family-given/given-family}
  \DeclareNameAlias{default}{family-given}

  % Italic et al. when using \citet{...}.
  % https:/tex.stackexchange.com/a/352119
  \DefineBibliographyStrings{english}{%
    andothers = {\emph{et al}\adddot}
  }

  \addbibresource{library.bib}
\fi

% Commands -------------------------------------------------------------

% Command to typeset with more separation between characters and words.
% Requires microtype for \textls: https:/tex.stackexchange.com/q/23921
% Note also that this is not the same command as REVTeX's \widetext.
%
% Usage: \widetext{{ ... commands go here ... }}{{ ... text to be copied ... }}
%
% Note the double braces in the above example.  Without the extra brace, a
% keyval error would result if the text has commas.
%
\ifdraftdoc
  % No fancy typesetting in draft mode.
  \def\widetext#1#2{\MakeUppercase{#1}}
\else
  \usepackage{accsupp} % to make the text copiable/searchable.
  \def\widetext#1#2{%
    \BeginAccSupp{method=escape,ActualText=#2}%
      \textls[120]{%
        \spaceskip=1.5\fontdimen2\font plus 1.5\fontdimen3\font minus 1.5\fontdimen4\font%
        \MakeUppercase{#1}%
      }%
    \EndAccSupp{}%
  }
\fi

% Link DOIs and arXiv preprints.
\def\crossref#1#2{\href{https:/doi.org/#1}{#2}}
\def\arxiv#1#2{\href{https:/arxiv.org/abs/#1}{arXiv:#1 [#2]}}

% Math -----------------------------------------------------------------

% Chapter-wise equation numbers.
\numberwithin{equation}{chapter}

\def\free#1{\ensuremath\mathcal{A}_{\hat{#1}}(#1)}
\def\mpd#1{\ensuremath\mathcal{P}_{\hat{#1}}(#1)}
\def\inmat#1{\ensuremath\begin{pmatrix}#1\end{pmatrix}}

% Math definitions.
% \overset with less vertical space.
% https:/tex.stackexchange.com/a/194805
\newcommand{\altoverset}[3][0ex]{%
  \mathrel{\mathop{#3}\limits^{
    \vbox to#1{\kern-1\ex@
    \hbox{$\scriptstyle#2$}\vss}}}}
\def\ogets#1{\ensuremath\altoverset{\gets}{#1}}
\def\oto#1{\ensuremath\altoverset{\to}{#1}}

% Memoir tweaks --------------------------------------------------------

% XXX: Move as much as possible to emem.sty

% Chapter precis (i.e., abstract for a chapter) tweaks.
% TODO: How to control spacing after the precis without a \\?
\setlength{\prechapterprecisshift}{-\baselineskip}
\def\precisfont{\normalfont\small}

% Header customization.
\nouppercaseheads
\def\headerstyle#1{\altsf@family@medium#1}
\ifsustyle
  \makeevenhead{headings}{}{}{\headerstyle{\thepage}}
  \makeoddhead{headings}{}{}{\headerstyle{\thepage}}
\else
  \makeevenhead{headings}{\headerstyle{\thepage}}{\headerstyle{\leftmark}}{}
  \makeoddhead{headings}{}{\headerstyle{\hskip0.05em\rightmark}}{\headerstyle{\thepage}}
\fi

% Chapter page footer: page number in the middle.
\makeoddfoot{plain}{}{\headerstyle{\thepage}}{}
\makeevenfoot{plain}{}{\headerstyle{\thepage}}{}

\def\appendixname{Appendix}

\setbeforesecskip{-1.333\onelineskip plus -0.2\onelineskip minus -0.2\onelineskip}
\setaftersecskip{.667\onelineskip plus 0.1\onelineskip}
\setbeforesubsecskip{-.889\onelineskip plus -0.1\onelineskip minus -0.1\onelineskip}
\setaftersubsecskip{0.444\onelineskip plus 0.05\onelineskip}
\setbeforesubsubsecskip{-0.667\onelineskip plus -0.1\onelineskip minus -0.1\onelineskip}
\setaftersubsubsecskip{0.333\onelineskip plus 0.05\onelineskip}

% TODO: fix me.
\def\fixme{(\textbf{??})}

\makeatother
